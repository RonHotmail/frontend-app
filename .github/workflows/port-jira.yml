name: Port Jira Ocean Integration
on:
  schedule:
    - cron: '*/30 * * * *' # Runs every 30 mins to keep data in sync
  workflow_dispatch:       # Allows you to click a button to run it manually

jobs:
  ocean-jira:
    runs-on: ubuntu-latest
    steps:
      - name: Run Port Ocean Jira Integration
        uses: port-labs/port-ocean-jira@v1
        with:
          port_client_id: ${{ secrets.PORT_CLIENT_ID }}
          port_client_secret: ${{ secrets.PORT_CLIENT_SECRET }}
          jira_host: ${{ secrets.OCEAN_JIRA_HOST }}
          jira_email: ${{ secrets.OCEAN_JIRA_USER }}
          jira_token: ${{ secrets.OCEAN_JIRA_TOKEN }}
          ocean_config: |
            resources:
              - kind: project
                selector:
                  query: "true"
                port:
                  entity:
                    mappings:
                      identifier: .key
                      title: .name
                      blueprint: '"jiraProject"'
                      properties:
                        projectTypeKey: .projectTypeKey
                        projectType: .projectType
              - kind: issue
                selector:
                  query: "true"
                port:
                  entity:
                    mappings:
                      identifier: .key
                      title: .fields.summary
                      blueprint: '"jiraIssue"'
                      properties:
                        status: .fields.status.name
                        assignee: .fields.assignee.displayName
                        priority: .fields.priority.name
                      relations:
                        # THIS IS THE KEY PART FOR THE ASSIGNMENT
                        # It maps the Jira Component Name -> Port Repository Identifier
                        repository: .fields.components[].name
