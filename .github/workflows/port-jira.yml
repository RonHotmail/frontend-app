name: Port Jira Ocean Integration
on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  ocean-jira:
    runs-on: ubuntu-latest
    steps:
      - name: Run Port Ocean Jira Integration
        uses: port-labs/port-ocean-integration-action@v1
        with:
          port_client_id: ${{ secrets.PORT_CLIENT_ID }}
          port_client_secret: ${{ secrets.PORT_CLIENT_SECRET }}
          identifier: "jira"  # Tells the action to use the Jira integration
          config: |
            resources:
              - kind: project
                selector:
                  query: "true"
                port:
                  entity:
                    mappings:
                      identifier: .key
                      title: .name
                      blueprint: '"jiraProject"'
                      properties:
                        projectTypeKey: .projectTypeKey
                        projectType: .projectType
              - kind: issue
                selector:
                  query: "true"
                port:
                  entity:
                    mappings:
                      identifier: .key
                      title: .fields.summary
                      blueprint: '"jiraIssue"'
                      properties:
                        status: .fields.status.name
                        assignee: .fields.assignee.displayName
                        priority: .fields.priority.name
                      relations:
                        # The mapping logic for the assignment
                        repository: .fields.components[].name
        env:
          # Mapping the secrets to the names the Jira integration expects
          JIRA_HOST: ${{ secrets.OCEAN_JIRA_HOST }}
          JIRA_EMAIL: ${{ secrets.OCEAN_JIRA_USER }}
          JIRA_TOKEN: ${{ secrets.OCEAN_JIRA_TOKEN }}
